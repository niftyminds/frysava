---
import fs from 'fs';
import path from 'path';

// Safe image loading with error handling
let imageFiles: string[] = [];
try {
  const imagesDir = path.join(process.cwd(), 'public/images/large');
  if (fs.existsSync(imagesDir)) {
    imageFiles = fs.readdirSync(imagesDir);
  } else {
    console.warn('Gallery: Images directory not found:', imagesDir);
  }
} catch (error) {
  console.error('Gallery: Error reading images directory:', error);
}

const allImages = imageFiles.filter(f => f.endsWith('.webp'));

// Select 5 images for the carousel preview
const carouselImages = allImages.slice(0, 5);
---

<section class="w-full overflow-hidden bg-sand-50 py-16" id="galerie">
  <div class="container mb-8">
    <h2 class="text-center mb-4">Galerie</h2>
    <p class="text-center text-charcoal-600">
      Prohlédněte si fotografie chalupy
    </p>
  </div>

  <!-- Infinite Carousel - Full Width -->
  <div class="relative w-screen -mx-[50vw] left-1/2 right-1/2">
    <div class="carousel-track flex gap-6">
      <!-- Images duplicated for seamless loop -->
      {carouselImages.concat(carouselImages).map((image, index) => {
        const imageNumber = (index % carouselImages.length) + 1;
        const actualIndex = index % carouselImages.length;
        return (
          <button
            class="flex-shrink-0 w-[90vw] sm:w-[500px] h-[250px] sm:h-[400px] cursor-pointer"
            data-gallery-open
            data-start-index={actualIndex}
          >
            <img
              src={`/images/large/${image}`}
              alt={`Fotografie chalupy na Fryšavě - obrázek ${imageNumber}`}
              class="w-full h-full object-cover rounded-lg shadow-lg hover:shadow-2xl transition-shadow"
              loading={index < 3 ? "eager" : "lazy"}
            />
          </button>
        );
      })}
    </div>
  </div>

  <!-- More Photos Link -->
  <div class="container text-center mt-8">
    <button
      class="text-moss-600 hover:text-moss-700 font-semibold text-lg flex items-center gap-2 mx-auto transition-colors"
      data-gallery-open
      data-start-index={0}
    >
      Více fotografií
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
      </svg>
    </button>
  </div>
</section>

<style>
  .carousel-track {
    animation: scroll-left 30s linear infinite;
    will-change: transform;
  }

  .carousel-track:hover {
    animation-play-state: paused;
  }

  @keyframes scroll-left {
    0% {
      transform: translateX(0);
    }
    100% {
      transform: translateX(-50%);
    }
  }

  /* Pause animation for users who prefer reduced motion */
  @media (prefers-reduced-motion: reduce) {
    .carousel-track {
      animation: none;
    }
  }
</style>

<style is:global>
  /* Lightbox Gallery Styles - Global to work with dynamically created elements */
  .gallery-lightbox {
    position: fixed !important;
    inset: 0 !important;
    z-index: 9999 !important;
    background: rgba(0, 0, 0, 0.95) !important;
    display: none !important;
    align-items: center !important;
    justify-content: center !important;
  }

  .gallery-lightbox.active {
    display: flex !important;
  }

  .lightbox-image {
    max-width: 90vw !important;
    max-height: 90vh !important;
    object-fit: contain !important;
    position: relative !important;
    z-index: 10000 !important;
  }

  .lightbox-nav {
    position: absolute !important;
    top: 50% !important;
    transform: translateY(-50%) !important;
    background: rgba(255, 255, 255, 0.1) !important;
    backdrop-filter: blur(8px) !important;
    border: 1px solid rgba(255, 255, 255, 0.2) !important;
    color: white !important;
    width: 48px !important;
    height: 48px !important;
    border-radius: 50% !important;
    cursor: pointer !important;
    transition: all 0.2s !important;
    z-index: 10001 !important;
  }

  .lightbox-nav:hover {
    background: rgba(255, 255, 255, 0.2) !important;
  }

  .lightbox-close {
    position: absolute !important;
    top: 20px !important;
    right: 20px !important;
    background: rgba(255, 255, 255, 0.1) !important;
    backdrop-filter: blur(8px) !important;
    border: 1px solid rgba(255, 255, 255, 0.2) !important;
    color: white !important;
    width: 48px !important;
    height: 48px !important;
    border-radius: 50% !important;
    cursor: pointer !important;
    font-size: 24px !important;
    transition: all 0.2s !important;
    z-index: 10001 !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
  }

  .lightbox-close:hover {
    background: rgba(255, 255, 255, 0.2) !important;
  }

  .lightbox-counter {
    position: absolute !important;
    bottom: 20px !important;
    left: 50% !important;
    transform: translateX(-50%) !important;
    background: rgba(0, 0, 0, 0.5) !important;
    backdrop-filter: blur(8px) !important;
    color: white !important;
    padding: 8px 16px !important;
    border-radius: 20px !important;
    font-size: 14px !important;
    z-index: 10001 !important;
  }
</style>

<script define:vars={{ allImages }}>
  // Lightbox Gallery
  console.log('Gallery script loaded. Total images:', allImages.length);
  let currentImageIndex = 0;

  function createLightbox() {
    const lightbox = document.createElement('div');
    lightbox.className = 'gallery-lightbox';
    lightbox.innerHTML = `
      <button class="lightbox-close" aria-label="Zavřít galerii">&times;</button>
      <button class="lightbox-nav" style="left: 20px;" data-nav="prev" aria-label="Předchozí fotografie">
        <svg class="w-6 h-6 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
        </svg>
      </button>
      <img class="lightbox-image" src="" alt="" />
      <button class="lightbox-nav" style="right: 20px;" data-nav="next" aria-label="Další fotografie">
        <svg class="w-6 h-6 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
        </svg>
      </button>
      <div class="lightbox-counter"></div>
    `;
    document.body.appendChild(lightbox);
    return lightbox;
  }

  // Initialize after DOM is ready
  function initLightbox() {
    const lightbox = createLightbox();
    const lightboxImage = lightbox.querySelector('.lightbox-image');
    const lightboxCounter = lightbox.querySelector('.lightbox-counter');

    if (!lightboxImage || !lightboxCounter) {
      console.error('Lightbox elements not found');
      return;
    }

    function updateLightbox() {
      const imagePath = '/images/large/' + allImages[currentImageIndex];
      lightboxImage.src = imagePath;
      lightboxImage.alt = 'Fotografie chalupy na Fryšavě - obrázek ' + (currentImageIndex + 1);
      lightboxCounter.textContent = (currentImageIndex + 1) + ' / ' + allImages.length;
    }

    function openLightbox(startIndex) {
      startIndex = startIndex || 0;
      currentImageIndex = startIndex;
      updateLightbox();
      lightbox.classList.add('active');
      document.body.style.overflow = 'hidden';

      // Debug: Check if lightbox is actually visible
      console.log('Lightbox opened with image:', allImages[currentImageIndex]);
      console.log('Lightbox classList:', lightbox.className);
      console.log('Lightbox display:', window.getComputedStyle(lightbox).display);
      console.log('Lightbox z-index:', window.getComputedStyle(lightbox).zIndex);
      console.log('Lightbox position:', window.getComputedStyle(lightbox).position);
      console.log('Lightbox visibility:', window.getComputedStyle(lightbox).visibility);
      console.log('Lightbox opacity:', window.getComputedStyle(lightbox).opacity);
    }

    function closeLightbox() {
      lightbox.classList.remove('active');
      document.body.style.overflow = '';
    }

    function navigateLightbox(direction) {
      if (direction === 'prev') {
        currentImageIndex = (currentImageIndex - 1 + allImages.length) % allImages.length;
      } else {
        currentImageIndex = (currentImageIndex + 1) % allImages.length;
      }
      updateLightbox();
    }

    // Event listeners
    var galleryButtons = document.querySelectorAll('[data-gallery-open]');
    console.log('Found gallery buttons:', galleryButtons.length);

    galleryButtons.forEach(function(button) {
      button.addEventListener('click', function(e) {
        e.preventDefault();
        var startIndex = parseInt(button.getAttribute('data-start-index') || '0');
        console.log('Opening lightbox at index:', startIndex);
        openLightbox(startIndex);
      });
    });

    var closeBtn = lightbox.querySelector('.lightbox-close');
    if (closeBtn) {
      closeBtn.addEventListener('click', closeLightbox);
    }

    lightbox.querySelectorAll('[data-nav]').forEach(function(button) {
      button.addEventListener('click', function() {
        var direction = button.getAttribute('data-nav');
        navigateLightbox(direction);
      });
    });

    lightbox.addEventListener('click', function(e) {
      if (e.target === lightbox) {
        closeLightbox();
      }
    });

    // Keyboard navigation
    document.addEventListener('keydown', function(e) {
      if (!lightbox.classList.contains('active')) return;

      if (e.key === 'Escape') {
        closeLightbox();
      } else if (e.key === 'ArrowLeft') {
        navigateLightbox('prev');
      } else if (e.key === 'ArrowRight') {
        navigateLightbox('next');
      }
    });

    console.log('Lightbox initialized successfully');
  }

  // Run initialization immediately (Astro scripts are already deferred)
  initLightbox();
</script>

