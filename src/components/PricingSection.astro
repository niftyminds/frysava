---
import yaml from 'js-yaml';
import fs from 'fs';
import path from 'path';

const pricingDataPath = path.join(process.cwd(), 'src/data/pricing.yaml');
const pricingData = yaml.load(fs.readFileSync(pricingDataPath, 'utf8'));
---

<section id="cenik" class="section bg-white">
  <div class="container">
    <!-- Main Pricing Table -->
    <div class="max-w-4xl mx-auto mb-12">
      <div class="bg-gradient-to-br from-sand-50 to-moss-50 rounded-xl overflow-hidden shadow-lg border border-sand-200">
        <table class="w-full">
          <thead>
            <tr class="bg-moss-600 text-white">
              <th class="px-6 py-4 text-left">Období</th>
              <th class="px-6 py-4 text-left">Termín</th>
              <th class="px-6 py-4 text-right">Cena</th>
            </tr>
          </thead>
          <tbody>
            {pricingData.seasons.map((season, index) => (
              <tr class={index % 2 === 0 ? 'bg-white' : 'bg-sand-50/50'}>
                <td class="px-6 py-4 font-semibold text-wood-900">{season.name}</td>
                <td class="px-6 py-4 text-charcoal-700">{season.period}</td>
                <td class="px-6 py-4 text-right">
                  <span class="text-2xl font-bold text-moss-700">
                    {season.price_per_person} {season.currency}
                  </span>
                  <span class="text-sm text-charcoal-600 block">/ osoba / noc</span>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Link to open modal with additional info -->
    <div class="max-w-4xl mx-auto mb-12 text-center">
      <button
        id="open-pricing-modal"
        class="inline-flex items-center gap-2 text-moss-600 hover:text-moss-700 font-semibold text-lg transition-colors"
      >
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        Zobrazit dodatečné poplatky a podmínky
      </button>
    </div>

    <!-- Modal with additional fees and policies -->
    <dialog
      id="pricing-modal"
      class="max-w-4xl w-full backdrop:bg-black/50 rounded-2xl shadow-2xl border-2 border-sand-200 p-0"
    >
      <div class="bg-white rounded-2xl overflow-hidden">
        <!-- Modal header -->
        <div class="bg-moss-600 text-white px-6 py-4 flex justify-end sticky top-0">
          <button
            id="close-pricing-modal"
            class="p-2 hover:bg-moss-700 rounded-lg transition-colors"
            aria-label="Zavřít"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>

        <!-- Modal content -->
        <div class="p-8 max-h-[70vh] overflow-y-auto space-y-8">
          <!-- Additional Fees -->
          <div>
            <h4 class="text-xl font-semibold text-wood-900 mb-4 pb-2 border-b border-sand-200">Dodatečné poplatky</h4>
            <ul class="space-y-3">
              {pricingData.fees.map((fee) => (
                <li class="flex justify-between items-start">
                  <div>
                    <p class="font-medium text-charcoal-900">{fee.name}</p>
                    <p class="text-sm text-charcoal-600">{fee.unit}</p>
                  </div>
                  <p class="text-right">
                    {fee.note && <span class="text-sm text-charcoal-600 block">{fee.note}</span>}
                    <span class="font-semibold text-charcoal-900">{fee.price} Kč</span>
                  </p>
                </li>
              ))}
            </ul>
          </div>

          <!-- Check-in / Check-out -->
          {pricingData.checkin_checkout && (
            <div>
              <h4 class="text-xl font-semibold text-wood-900 mb-4 pb-2 border-b border-sand-200">Check-in / Check-out</h4>
              <div class="space-y-2">
                <p class="text-charcoal-700">
                  <span class="font-semibold text-wood-900">Check-in od:</span>
                  {' '}{pricingData.checkin_checkout.checkin_from}
                </p>
                <p class="text-charcoal-700">
                  <span class="font-semibold text-wood-900">Check-out do:</span>
                  {' '}{pricingData.checkin_checkout.checkout_until}
                </p>
                {pricingData.checkin_checkout.note && (
                  <p class="text-sm text-charcoal-600 italic mt-2">{pricingData.checkin_checkout.note}</p>
                )}
              </div>
            </div>
          )}

          <!-- Payment Conditions -->
          {pricingData.payment && (
            <div>
              <h4 class="text-xl font-semibold text-wood-900 mb-4 pb-2 border-b border-sand-200">Platební podmínky</h4>
              <div class="space-y-3">
                <p class="text-charcoal-700">
                  <span class="font-semibold text-wood-900">Záloha:</span>
                  {' '}{pricingData.payment.deposit_percent}% {pricingData.payment.deposit_note ? `(${pricingData.payment.deposit_note})` : ''}
                </p>
                <p class="text-charcoal-700">
                  <span class="font-semibold text-wood-900">Doplatek:</span>
                  {' '}{pricingData.payment.final_payment}
                </p>
                {pricingData.payment.accepted_methods && pricingData.payment.accepted_methods.length > 0 && (
                  <div>
                    <p class="font-semibold text-wood-900 mb-2">Způsoby platby:</p>
                    <ul class="list-disc list-inside space-y-1 ml-4">
                      {pricingData.payment.accepted_methods.map((method) => (
                        <li class="text-charcoal-700">{method}</li>
                      ))}
                    </ul>
                  </div>
                )}
              </div>
            </div>
          )}

          <!-- Cancellation Policy -->
          {pricingData.cancellation && (
            <div>
              <h4 class="text-xl font-semibold text-wood-900 mb-4 pb-2 border-b border-sand-200">Stornopodmínky</h4>
              <ul class="space-y-2">
                {pricingData.cancellation.map((policy) => (
                  <li class="text-charcoal-700">
                    <span class="font-semibold text-wood-900">{policy.period}:</span>
                    {' '}{policy.description}
                  </li>
                ))}
              </ul>
            </div>
          )}
        </div>
      </div>
    </dialog>

    <!-- Notes -->
    {pricingData.notes && (
      <div class="max-w-4xl mx-auto mt-8 text-center">
        {pricingData.notes.map((note) => (
          <p class="text-sm text-charcoal-600 italic">{note}</p>
        ))}
      </div>
    )}

    <!-- CTA -->
    <div class="text-center mt-12">
      <a href="#kontakt" class="btn-primary text-lg px-8 py-4">
        Poptat termín
      </a>
    </div>
  </div>
</section>

<script>
  const openModalBtn = document.getElementById('open-pricing-modal');
  const closeModalBtn = document.getElementById('close-pricing-modal');
  const modal = document.getElementById('pricing-modal') as HTMLDialogElement;

  openModalBtn?.addEventListener('click', () => {
    modal?.showModal();
    document.body.style.overflow = 'hidden';
  });

  closeModalBtn?.addEventListener('click', () => {
    modal?.close();
    document.body.style.overflow = '';
  });

  // Close on backdrop click
  modal?.addEventListener('click', (e) => {
    const rect = modal.getBoundingClientRect();
    const isInDialog = (rect.top <= e.clientY && e.clientY <= rect.top + rect.height &&
      rect.left <= e.clientX && e.clientX <= rect.left + rect.width);
    if (!isInDialog) {
      modal.close();
      document.body.style.overflow = '';
    }
  });

  // Close on Escape key
  modal?.addEventListener('cancel', () => {
    document.body.style.overflow = '';
  });
</script>
